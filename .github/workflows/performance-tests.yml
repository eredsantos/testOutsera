name: Performance Tests - k6

on:
  workflow_dispatch:
    inputs:
      vus:
        description: 'NÃºmero de usuÃ¡rios virtuais'
        required: false
        default: '500'
      duration:
        description: 'DuraÃ§Ã£o do teste (ex: 5m, 10m)'
        required: false
        default: '5m'

jobs:
  load-test:
    name: Teste de Carga
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ðŸ“š Instalar dependÃªncias npm
        run: npm ci
      
      - name: ðŸš€ Instalar k6
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg dirmngr
          sudo mkdir -p /root/.gnupg
          sudo chmod 700 /root/.gnupg
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6
      
      - name: âœ… Verificar instalaÃ§Ã£o do k6
        run: k6 version
      
      - name: ðŸ“ Criar arquivo .env
        run: |
          cat > .env << EOF
          LOAD_TEST_BASE_URL=${{ secrets.LOAD_TEST_BASE_URL || 'https://httpbin.org' }}
          LOAD_TEST_ENDPOINT=${{ secrets.LOAD_TEST_ENDPOINT || '/headers' }}
          LOAD_TEST_VUS=${{ github.event.inputs.vus || secrets.LOAD_TEST_VUS || '500' }}
          LOAD_TEST_DURATION=${{ github.event.inputs.duration || secrets.LOAD_TEST_DURATION || '5m' }}
          EOF
      
      - name: ðŸ§ª Executar teste de carga
        run: npm run test:load
        continue-on-error: true
      
      - name: ðŸ“Š Upload dos relatÃ³rios HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-performance-reports
          path: src/performance/reports/*.html
          retention-days: 30
      
      - name: ðŸ“„ Upload dos relatÃ³rios JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-performance-json
          path: src/performance/reports/*.json
          retention-days: 30
      
      - name: ðŸ“ƒ Upload dos relatÃ³rios TXT
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-performance-txt
          path: src/performance/reports/*.txt
          retention-days: 30
      
      - name: ðŸ“‹ Mostrar resumo no console
        if: always()
        run: |
          echo "### ðŸ“Š Teste de Performance ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**VUs:** ${{ github.event.inputs.vus || secrets.LOAD_TEST_VUS || '500' }}" >> $GITHUB_STEP_SUMMARY
          echo "**DuraÃ§Ã£o:** ${{ github.event.inputs.duration || secrets.LOAD_TEST_DURATION || '5m' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f src/performance/reports/*.txt ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat src/performance/reports/*.txt | head -50 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
